CREATE OR REPLACE FUNCTION P_ISI_D_KELUHAN(
	KD_KELUHAN1 character varying,
	KD_LAYANAN1 character varying,
	JUDUL_KELUHAN1 character varying,
	USER_KELUHAN1 character varying,
	NO_HP1 character varying,
	EMAIL1 character varying,
	KELUHAN1 character varying,
	TGL_KELUHAN1 character varying,
	PETUGAS_PENERIMA1 character varying,
	KD_STATUS1 character varying,
	PENINDAK_LANJUT1 character varying,
	TGL_TINDAK_LANJUT1 character varying,
	DETAIL_TINDAK_LANJUT1 character varying,
	TGL_SELESAI1 character varying
)
RETURNS character varying AS 
$BODY$
DECLARE 
	CACAH NUMERIC;

BEGIN
	SELECT COUNT(*) INTO CACAH FROM D_KELUHAN WHERE KD_KELUHAN = KD_KELUHAN1;
	IF CACAH > 0 THEN
		UPDATE D_KELUHAN SET KD_LAYANAN = KD_LAYANAN1, JUDUL_KELUHAN = JUDUL_KELUHAN1, USER_KELUHAN = USER_KELUHAN1, NO_HP = NO_HP1, EMAIL = EMAIL1, KELUHAN = KELUHAN1, TGL_KELUHAN = TO_DATE(TGL_KELUHAN1, 'DD/MM/YYYY'), PETUGAS_PENERIMA = PETUGAS_PENERIMA1, KD_STATUS = KD_STATUS1, PENINDAK_LANJUT = PENINDAK_LANJUT1, TGL_TINDAK_LANJUT = TO_DATE(TGL_TINDAK_LANJUT1, 'DD/MM/YYYY'), DETAIL_TINDAK_LANJUT = DETAIL_TINDAK_LANJUT1, TGL_SELESAI = TO_DATE(TGL_SELESAI1, 'DD/MM/YYYY'), TGL_UPDATE = current_timestamp WHERE KD_KELUHAN = KD_KELUHAN1;
	ELSE
		INSERT INTO D_KELUHAN (KD_KELUHAN, KD_LAYANAN, JUDUL_KELUHAN, USER_KELUHAN, NO_HP, EMAIL, KELUHAN, TGL_KELUHAN, PETUGAS_PENERIMA, KD_STATUS, PENINDAK_LANJUT, TGL_TINDAK_LANJUT, DETAIL_TINDAK_LANJUT, TGL_SELESAI, TGL_UPDATE) VALUES (KD_KELUHAN1, KD_LAYANAN1, JUDUL_KELUHAN1, USER_KELUHAN1, NO_HP1, EMAIL1, KELUHAN1, TO_DATE(TGL_KELUHAN1, 'DD/MM/YYYY'), PETUGAS_PENERIMA1, KD_STATUS1, PENINDAK_LANJUT1, TO_DATE(TGL_TINDAK_LANJUT1, 'DD/MM/YYYY'), DETAIL_TINDAK_LANJUT1, TO_DATE(TGL_SELESAI1, 'DD/MM/YYYY'), current_timestamp);
	END IF;

	RETURN 'OKE';
END;
$BODY$
	LANGUAGE plpgsql VOLATILE;


-- TINDAK LANJUT
CREATE OR REPLACE FUNCTION P_ISI_D_KELUHAN_LANJUT(
	KD_KELUHAN1 character varying,
	KD_STATUS1 character varying,
	PENINDAK_LANJUT1 character varying,
	TGL_TINDAK_LANJUT1 character varying,
	DETAIL_TINDAK_LANJUT1 character varying,
	TGL_SELESAI1 character varying
)
RETURNS character varying AS 
$BODY$
DECLARE 
	CACAH NUMERIC;
	ERR_MSG VARCHAR;
BEGIN
	SELECT COUNT(*) INTO CACAH FROM D_KELUHAN WHERE KD_KELUHAN = KD_KELUHAN1;
	ERR_MSG := 'DATA KELUHAN TIDAK DITEMUKAN';
	IF CACAH > 0 THEN
		UPDATE D_KELUHAN SET KD_STATUS = KD_STATUS1, PENINDAK_LANJUT = PENINDAK_LANJUT1, TGL_TINDAK_LANJUT = TO_DATE(TGL_TINDAK_LANJUT1, 'DD/MM/YYYY'), DETAIL_TINDAK_LANJUT = DETAIL_TINDAK_LANJUT1, TGL_SELESAI = TO_DATE(TGL_SELESAI1, 'DD/MM/YYYY'), TGL_UPDATE = current_timestamp WHERE KD_KELUHAN = KD_KELUHAN1;
	ELSE
		RAISE EXCEPTION '%', ERR_MSG;
	END IF;

	RETURN 'OKE';
END;
$BODY$
	LANGUAGE plpgsql VOLATILE;



